@page "/accounts"
@inject AccountManagementService AccountManagement
@inject AccountCategoryManagementService CategoryManagement
@inject AccountTelegramToolsService AccountTelegramTools
@inject TelegramPanel.Core.Services.AccountRiskService RiskService
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject NavigationManager Navigation
@using TelegramPanel.Data.Entities
@using TelegramPanel.Web.Components.Dialogs
@implements IDisposable

<PageTitle>账号列表 - Telegram Panel</PageTitle>

<MudText Typo="Typo.h4" Class="mb-4">账号列表</MudText>

<MudCard>
    <MudCardContent>
        <MudTable Items="@filteredAccounts" Hover="true" Breakpoint="Breakpoint.Sm" Loading="@loading"
                  MultiSelection="true" @bind-SelectedItems="selectedAccounts">
            <ToolBarContent>
                <MudText Typo="Typo.h6">已导入账号 (@accounts.Count)</MudText>
                <MudSpacer />
                <MudSelect @bind-Value="filterCategoryId" Label="分类" Variant="Variant.Outlined" Dense="true" Class="mr-2" Style="min-width: 160px;">
                    <MudSelectItem Value="0">全部分类</MudSelectItem>
                    @foreach (var c in categories)
                    {
                        <MudSelectItem Value="@c.Id">@c.Name</MudSelectItem>
                    }
                </MudSelect>
                <MudTextField @bind-Value="searchString" Placeholder="搜索账号..." Adornment="Adornment.Start"
                              AdornmentIcon="@Icons.Material.Filled.Search" IconSize="Size.Medium" Class="mt-0"
                              Immediate="true" />
                <MudButton Variant="Variant.Outlined" Color="Color.Primary" StartIcon="@SelectionToggleIcon"
                           Disabled="@(loading || !filteredAccounts.Any())" OnClick="CycleSelectionToggle" Class="ml-2">
                    @SelectionToggleText
                </MudButton>
                <MudButton Variant="Variant.Outlined" Color="Color.Error" StartIcon="@Icons.Material.Filled.Delete"
                           Disabled="@(loading || selectedAccounts.Count == 0)" OnClick="DeleteSelectedAccounts" Class="ml-2">
                    删除已选
                </MudButton>
                <MudButton Variant="Variant.Outlined" Color="Color.Warning" StartIcon="@Icons.Material.Filled.Password"
                           Disabled="@(loading || selectedAccounts.Count == 0)" OnClick="OpenBatchChangeTwoFactorPassword" Class="ml-2">
                    修改二级密码（已选）
                </MudButton>
                <MudButton Variant="Variant.Outlined" Color="Color.Warning" StartIcon="@Icons.Material.Filled.Edit"
                           Disabled="@(loading || selectedAccounts.Count == 0)" OnClick="OpenBatchChangeNickname" Class="ml-2">
                    批量改昵称（已选）
                </MudButton>
                <MudButton Variant="Variant.Outlined" Color="Color.Warning" StartIcon="@Icons.Material.Filled.AlternateEmail"
                           Disabled="@(loading || selectedAccounts.Count == 0)" OnClick="OpenBatchChangeUsername" Class="ml-2">
                    批量改用户名（已选）
                </MudButton>
                <MudButton Variant="Variant.Outlined" Color="Color.Warning" StartIcon="@Icons.Material.Filled.Edit"
                           Disabled="@(loading || selectedAccounts.Count == 0)" OnClick="OpenBatchChangeBio" Class="ml-2">
                    批量改Bio（已选）
                </MudButton>
                <MudButton Variant="Variant.Outlined" Color="Color.Info" StartIcon="@Icons.Material.Filled.Sync"
                           Disabled="@loading" OnClick="BatchRefreshTelegramStatus" Class="ml-2">
                    批量刷新状态
                </MudButton>
                <MudButton Variant="Variant.Outlined" Color="Color.Success" StartIcon="@Icons.Material.Filled.FolderZip"
                           Disabled="@loading" OnClick="ExportSelectedAccounts" Class="ml-2">
                    导出已选
                </MudButton>
                <MudButton Variant="Variant.Outlined" Color="Color.Success" StartIcon="@Icons.Material.Filled.FolderZip"
                           Disabled="@loading" OnClick="ExportCurrentAccounts" Class="ml-2">
                    导出当前列表
                </MudButton>
                <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Refresh"
                           OnClick="LoadAccounts" Class="ml-2">刷新</MudButton>
            </ToolBarContent>
            <HeaderContent>
                <MudTh>手机号</MudTh>
                <MudTh>昵称</MudTh>
                <MudTh>用户名</MudTh>
                <MudTh>用户ID</MudTh>
                <MudTh>分类</MudTh>
                <MudTh>频道/群组</MudTh>
                <MudTh>状态</MudTh>
                <MudTh>Telegram 状态</MudTh>
                <MudTh>最后数据同步</MudTh>
                <MudTh>操作</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd DataLabel="手机号">@context.Phone</MudTd>
                <MudTd DataLabel="昵称">@(context.Nickname ?? "-")</MudTd>
                <MudTd DataLabel="用户名">@(context.Username ?? "-")</MudTd>
                <MudTd DataLabel="用户ID">@context.UserId</MudTd>
                <MudTd DataLabel="分类">
                    @if (context.Category != null)
                    {
                        <MudChip T="string" Size="Size.Small" Style="@($"background-color: {context.Category.Color ?? "#9E9E9E"}")">
                            @context.Category.Name
                        </MudChip>
                    }
                    else
                    {
                        <MudText Typo="Typo.body2" Color="Color.Default">未分类</MudText>
                    }
                </MudTd>
                <MudTd DataLabel="频道/群组">
                    <MudText Typo="Typo.body2">@context.Channels.Count / @context.Groups.Count</MudText>
                </MudTd>
                <MudTd DataLabel="状态">
                    <MudChip T="string" Size="Size.Small" Color="@(context.IsActive ? Color.Success : Color.Default)">
                        @(context.IsActive ? "活跃" : "停用")
                    </MudChip>
                </MudTd>
                <MudTd DataLabel="Telegram 状态">
                    @if (telegramStatus.TryGetValue(context.Id, out var s))
                    {
                        <MudChip T="string" Size="Size.Small" Color="@(s.Ok ? Color.Success : Color.Error)" Title="@(BuildTelegramStatusTitle(s))">
                            @s.Summary
                        </MudChip>
                    }
                    else
                    {
                        <MudChip T="string" Size="Size.Small" Color="Color.Default">未检测</MudChip>
                    }
                </MudTd>
                <MudTd DataLabel="最后数据同步">@context.LastSyncAt.ToString("yyyy-MM-dd HH:mm")</MudTd>
                <MudTd DataLabel="操作">
                    <MudIconButton Icon="@Icons.Material.Filled.Info" Size="Size.Small" Color="Color.Info"
                                   OnClick="@(() => ShowDetails(context))" Title="查看详情" />
                    <MudIconButton Icon="@Icons.Material.Filled.Edit" Size="Size.Small" Color="Color.Info"
                                   Disabled="@loading" OnClick="@(() => OpenEditUserProfile(context))" Title="编辑用户资料" />
                    <MudIconButton Icon="@Icons.Material.Filled.Sync" Size="Size.Small" Color="Color.Primary"
                                   Disabled="@loading" OnClick="@(() => RefreshTelegramStatus(context))" Title="刷新 Telegram 状态" />
                    <MudIconButton Icon="@Icons.Material.Filled.MarkEmailUnread" Size="Size.Small" Color="Color.Info"
                                   Disabled="@loading" OnClick="@(() => OpenSystemInbox(context))" Title="系统通知（验证码）" />
                    <MudIconButton Icon="@Icons.Material.Filled.Devices" Size="Size.Small" Color="Color.Info"
                                   Disabled="@loading" OnClick="@(() => OpenDevices(context))" Title="在线设备" />
                    <MudIconButton Icon="@Icons.Material.Filled.Password" Size="Size.Small" Color="Color.Warning"
                                   Disabled="@loading" OnClick="@(() => OpenChangeTwoFactorPassword(context))" Title="修改二级密码" />
                    <MudIconButton Icon="@Icons.Material.Filled.AlternateEmail" Size="Size.Small" Color="Color.Warning"
                                   Disabled="@loading" OnClick="@(() => OpenChangeTwoFactorRecoveryEmail(context))" Title="绑定/换绑找回邮箱" />
                    <MudIconButton Icon="@(context.IsActive ? Icons.Material.Filled.Stop : Icons.Material.Filled.PlayArrow)"
                                   Size="Size.Small" Color="@(context.IsActive ? Color.Warning : Color.Success)"
                                   OnClick="@(() => ToggleActive(context))"
                                   Title="@(context.IsActive ? "停用" : "启用")" />
                    <MudIconButton Icon="@Icons.Material.Filled.Delete" Size="Size.Small" Color="Color.Error"
                                   OnClick="@(() => DeleteAccount(context))" Title="删除账号" />
                </MudTd>
            </RowTemplate>
            <NoRecordsContent>
                <MudText>暂无账号数据，请先<MudLink Href="/accounts/import">导入账号</MudLink></MudText>
            </NoRecordsContent>
            <LoadingContent>
                <MudProgressCircular Indeterminate="true" />
            </LoadingContent>
        </MudTable>
    </MudCardContent>
</MudCard>

@code {
    private List<Account> accounts = new();
    private List<AccountCategory> categories = new();
    private bool loading = true;
    private string searchString = "";
    private int filterCategoryId = 0;
    private readonly Dictionary<int, TelegramAccountStatusResult> telegramStatus = new();
    private HashSet<Account> selectedAccounts = new();
    private readonly CancellationTokenSource _pageCts = new();

    private IEnumerable<Account> filteredAccounts =>
        accounts.Where(a =>
        {
            if (filterCategoryId > 0 && a.CategoryId != filterCategoryId)
                return false;

            if (string.IsNullOrWhiteSpace(searchString))
                return true;

            return a.Phone.Contains(searchString, StringComparison.OrdinalIgnoreCase)
                   || (a.Nickname?.Contains(searchString, StringComparison.OrdinalIgnoreCase) ?? false)
                   || (a.Username?.Contains(searchString, StringComparison.OrdinalIgnoreCase) ?? false)
                   || a.UserId.ToString().Contains(searchString);
        });

    protected override async Task OnInitializedAsync()
    {
        await LoadCategories();
        await LoadAccounts();
    }

    private async Task LoadCategories()
    {
        try
        {
            var list = await CategoryManagement.GetAllCategoriesAsync();
            categories = list.ToList();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"加载分类失败：{ex.Message}", Severity.Error);
        }
    }

    private async Task LoadAccounts()
    {
        loading = true;
        try
        {
            var accountList = await AccountManagement.GetAllAccountsAsync();
            accounts = accountList.ToList();

            // 刷新账号列表后，从数据库重建“Telegram 状态”缓存（避免刷新页面后回到未检测）
            telegramStatus.Clear();
            foreach (var a in accounts)
            {
                if (!a.TelegramStatusCheckedAtUtc.HasValue)
                    continue;
                if (string.IsNullOrWhiteSpace(a.TelegramStatusSummary))
                    continue;

                telegramStatus[a.Id] = new TelegramAccountStatusResult(
                    Ok: a.TelegramStatusOk ?? false,
                    Summary: a.TelegramStatusSummary,
                    Details: a.TelegramStatusDetails,
                    CheckedAtUtc: a.TelegramStatusCheckedAtUtc.Value);
            }

            var ids = new HashSet<int>(accounts.Select(a => a.Id));
            await LoadCategories();

            // 清理已选中但已不存在的账号
            selectedAccounts = selectedAccounts.Where(a => ids.Contains(a.Id)).ToHashSet();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"加载失败：{ex.Message}", Severity.Error);
        }
        finally
        {
            loading = false;
        }
    }

    private async Task ShowDetails(Account account)
    {
        var (channels, groups) = await AccountManagement.GetAccountStatisticsAsync(account.Id);
        var message = $"账号详情：\n手机号：{account.Phone}\n用户名：{account.Username ?? "无"}\n用户ID：{account.UserId}\n分类：{account.Category?.Name ?? "未分类"}\n创建的频道：{channels} 个\n创建的群组：{groups} 个\n创建时间：{account.CreatedAt:yyyy-MM-dd HH:mm}\n最后数据同步：{account.LastSyncAt:yyyy-MM-dd HH:mm}\nSession路径：{account.SessionPath}";
        await DialogService.ShowMessageBox("账号详情", message, "关闭");
    }

    private async Task OpenChangeTwoFactorPassword(Account account)
    {
        if (loading)
            return;

        var parameters = new DialogParameters
        {
            ["AccountIds"] = new List<int> { account.Id }
        };
        var options = new DialogOptions { CloseOnEscapeKey = true, MaxWidth = MaxWidth.Small, FullWidth = true };
        DialogService.Show<TelegramPanel.Web.Components.Dialogs.ChangeTwoFactorPasswordDialog>("修改二级密码", parameters, options);
        await Task.CompletedTask;
    }

    private async Task OpenChangeTwoFactorRecoveryEmail(Account account)
    {
        if (loading)
            return;

        var parameters = new DialogParameters
        {
            ["AccountId"] = account.Id
        };
        var options = new DialogOptions { CloseOnEscapeKey = true, MaxWidth = MaxWidth.Small, FullWidth = true };
        DialogService.Show<TelegramPanel.Web.Components.Dialogs.ChangeTwoFactorRecoveryEmailDialog>("绑定/换绑找回邮箱", parameters, options);
        await Task.CompletedTask;
    }

    private async Task OpenEditUserProfile(Account account)
    {
        if (loading)
            return;

        var parameters = new DialogParameters
        {
            ["AccountId"] = account.Id
        };
        var options = new DialogOptions { CloseOnEscapeKey = true, MaxWidth = MaxWidth.Medium, FullWidth = true };
        var dialog = DialogService.Show<TelegramPanel.Web.Components.Dialogs.EditUserProfileDialog>("编辑用户资料", parameters, options)!;
        var result = await dialog.Result;
        if (result is { Canceled: false })
            await LoadAccounts();
    }

    private async Task OpenBatchChangeTwoFactorPassword()
    {
        if (loading)
            return;

        var ids = selectedAccounts.Select(a => a.Id).Distinct().ToList();
        if (ids.Count == 0)
        {
            Snackbar.Add("请先选择账号", Severity.Info);
            return;
        }

        var parameters = new DialogParameters
        {
            ["AccountIds"] = ids
        };
        var options = new DialogOptions { CloseOnEscapeKey = true, MaxWidth = MaxWidth.Small, FullWidth = true };
        DialogService.Show<TelegramPanel.Web.Components.Dialogs.ChangeTwoFactorPasswordDialog>("批量修改二级密码", parameters, options);
        await Task.CompletedTask;
    }

    private async Task OpenBatchChangeNickname()
    {
        if (loading)
            return;

        var ids = selectedAccounts.Select(a => a.Id).Distinct().ToList();
        if (ids.Count == 0)
        {
            Snackbar.Add("请先选择账号", Severity.Info);
            return;
        }

        var parameters = new DialogParameters
        {
            ["AccountIds"] = ids
        };
        var options = new DialogOptions { CloseOnEscapeKey = true, MaxWidth = MaxWidth.Medium, FullWidth = true };
        var dialog = DialogService.Show<TelegramPanel.Web.Components.Dialogs.BatchChangeNicknameDialog>("批量修改昵称", parameters, options)!;
        var result = await dialog.Result;
        if (result is { Canceled: false })
            await LoadAccounts();
    }

    private async Task OpenBatchChangeUsername()
    {
        if (loading)
            return;

        var ids = selectedAccounts.Select(a => a.Id).Distinct().ToList();
        if (ids.Count == 0)
        {
            Snackbar.Add("请先选择账号", Severity.Info);
            return;
        }

        var parameters = new DialogParameters
        {
            ["AccountIds"] = ids
        };
        var options = new DialogOptions { CloseOnEscapeKey = true, MaxWidth = MaxWidth.Medium, FullWidth = true };
        var dialog = DialogService.Show<TelegramPanel.Web.Components.Dialogs.BatchChangeUsernameDialog>("批量修改用户名", parameters, options)!;
        var result = await dialog.Result;
        if (result is { Canceled: false })
            await LoadAccounts();
    }

    private async Task OpenBatchChangeBio()
    {
        if (loading)
            return;

        var ids = selectedAccounts.Select(a => a.Id).Distinct().ToList();
        if (ids.Count == 0)
        {
            Snackbar.Add("请先选择账号", Severity.Info);
            return;
        }

        var parameters = new DialogParameters
        {
            ["AccountIds"] = ids
        };
        var options = new DialogOptions { CloseOnEscapeKey = true, MaxWidth = MaxWidth.Medium, FullWidth = true };
        var dialog = DialogService.Show<TelegramPanel.Web.Components.Dialogs.BatchChangeBioDialog>("批量修改 Bio", parameters, options)!;
        var result = await dialog.Result;
        if (result is { Canceled: false })
            await LoadAccounts();
    }

    private static string BuildTelegramStatusTitle(TelegramAccountStatusResult s)
    {
        var details = string.IsNullOrWhiteSpace(s.Details) ? s.Summary : s.Details;
        return $"{details}（检测时间：{s.CheckedAtUtc:yyyy-MM-dd HH:mm}）";
    }

    private async Task RefreshTelegramStatus(Account account)
    {
        try
        {
            loading = true;
            bool? probeResult = await DialogService.ShowMessageBox(
                "刷新 Telegram 状态",
                "是否进行深度探测（将创建并删除一个测试频道，用于判断【创建频道接口是否被冻结】）？",
                yesText: "深度探测",
                cancelText: "普通刷新");

            var probe = probeResult == true;

            // 风控检查：深度探测是敏感操作
            if (probe)
            {
                var riskCheck = RiskService.CheckLoginDuration(account);
                if (riskCheck.IsRisky)
                {
                    var parameters = new DialogParameters
                    {
                        ["Message"] = riskCheck.Message,
                        ["DetailedMessage"] = riskCheck.DetailedMessage,
                        ["ShowRecommendations"] = true
                    };
                    var options = new DialogOptions { CloseOnEscapeKey = true, MaxWidth = MaxWidth.Medium };
                    var dialog = DialogService.Show<RiskWarningDialog>("风控警告", parameters, options);
                    var dialogResult = await dialog.Result;
                    if (dialogResult.Canceled)
                    {
                        loading = false;
                        return; // 用户取消操作
                    }
                }
            }

            var result = await AccountTelegramTools.RefreshAccountStatusAsync(account.Id, probeCreateChannel: probe, cancellationToken: _pageCts.Token);
            telegramStatus[account.Id] = result;

            // 资料刷新后重新加载（昵称/用户名/用户ID 可能更新）
            await LoadAccounts();

            Snackbar.Add($"账号 {account.Phone} 状态：{result.Summary}", result.Ok ? Severity.Success : Severity.Warning);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"刷新失败：{ex.Message}", Severity.Error);
        }
        finally
        {
            loading = false;
        }
    }

    private async Task BatchRefreshTelegramStatus()
    {
        if (accounts.Count == 0)
        {
            Snackbar.Add("暂无账号可刷新", Severity.Info);
            return;
        }

        loading = true;
        try
        {
            bool? probeResult = await DialogService.ShowMessageBox(
                "批量刷新 Telegram 状态",
                "是否进行深度探测（将对每个账号创建并删除一个测试频道，用于判断【创建频道接口是否被冻结】）？",
                yesText: "深度探测",
                cancelText: "普通刷新");

            var probe = probeResult == true;
            var targets = filteredAccounts.ToList();

            // 批量风控检查：深度探测是敏感操作
            if (probe && targets.Count > 0)
            {
                var batchCheck = RiskService.CheckBatchAccounts(targets);
                if (batchCheck.HasRiskyAccounts)
                {
                    var parameters = new DialogParameters
                    {
                        ["Message"] = $"检测到 {batchCheck.RiskyCount} 个风险账号",
                        ["DetailedMessage"] = batchCheck.GetRiskySummary(),
                        ["ShowRecommendations"] = true,
                        ["ShowExcludeOption"] = true,
                        ["RiskyAccounts"] = batchCheck.RiskyAccounts.ToList()
                    };
                    var options = new DialogOptions { CloseOnEscapeKey = true, MaxWidth = MaxWidth.Large };
                    var dialog = DialogService.Show<RiskWarningDialog>("批量操作风控警告", parameters, options);
                    var dialogResult = await dialog.Result;

                    if (dialogResult.Canceled)
                    {
                        loading = false;
                        return; // 用户取消操作
                    }

                    if (dialogResult.Data is TelegramPanel.Core.Services.RiskWarningAction action
                        && action == TelegramPanel.Core.Services.RiskWarningAction.ExcludeRisky)
                    {
                        // 排除风险账号后继续
                        targets = batchCheck.SafeAccounts.ToList();
                        if (targets.Count == 0)
                        {
                            Snackbar.Add("排除风险账号后无剩余账号", Severity.Info);
                            loading = false;
                            return;
                        }
                    }
                    // else: 用户选择继续所有账号
                }
            }

            foreach (var a in targets)
            {
                try
                {
                    var result = await AccountTelegramTools.RefreshAccountStatusAsync(a.Id, probeCreateChannel: probe, cancellationToken: _pageCts.Token);
                    telegramStatus[a.Id] = result;
                }
                catch (Exception ex)
                {
                    telegramStatus[a.Id] = new TelegramAccountStatusResult(
                        Ok: false,
                        Summary: "刷新失败",
                        Details: ex.Message,
                        CheckedAtUtc: DateTime.UtcNow);
                }

                StateHasChanged();
            }

            await LoadAccounts();
            Snackbar.Add($"批量刷新完成：{targets.Count} 个账号", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"批量刷新失败：{ex.Message}", Severity.Error);
        }
        finally
        {
            loading = false;
        }
    }

    public void Dispose()
    {
        try
        {
            _pageCts.Cancel();
        }
        catch
        {
            // ignore
        }
        finally
        {
            _pageCts.Dispose();
        }
    }

    private Task SelectAllFiltered()
    {
        selectedAccounts = filteredAccounts.ToHashSet();
        return Task.CompletedTask;
    }

    private Task InvertSelection()
    {
        var targets = filteredAccounts.ToList();
        foreach (var a in targets)
        {
            if (selectedAccounts.Contains(a))
                selectedAccounts.Remove(a);
            else
                selectedAccounts.Add(a);
        }
        return Task.CompletedTask;
    }

    private Task ClearSelection()
    {
        selectedAccounts.Clear();
        return Task.CompletedTask;
    }

    private SelectionToggleMode _selectionToggleMode = SelectionToggleMode.SelectAll;
    private string SelectionToggleText => _selectionToggleMode switch
    {
        SelectionToggleMode.SelectAll => "全选",
        SelectionToggleMode.Invert => "反选",
        SelectionToggleMode.Clear => "清空选择",
        _ => "全选"
    };

    private string SelectionToggleIcon => _selectionToggleMode switch
    {
        SelectionToggleMode.SelectAll => Icons.Material.Filled.SelectAll,
        SelectionToggleMode.Invert => Icons.Material.Filled.Flip,
        SelectionToggleMode.Clear => Icons.Material.Filled.Clear,
        _ => Icons.Material.Filled.SelectAll
    };

    private async Task CycleSelectionToggle()
    {
        switch (_selectionToggleMode)
        {
            case SelectionToggleMode.SelectAll:
                await SelectAllFiltered();
                _selectionToggleMode = SelectionToggleMode.Invert;
                break;
            case SelectionToggleMode.Invert:
                await InvertSelection();
                _selectionToggleMode = SelectionToggleMode.Clear;
                break;
            case SelectionToggleMode.Clear:
                await ClearSelection();
                _selectionToggleMode = SelectionToggleMode.SelectAll;
                break;
            default:
                _selectionToggleMode = SelectionToggleMode.SelectAll;
                break;
        }
    }

    private enum SelectionToggleMode
    {
        SelectAll = 0,
        Invert = 1,
        Clear = 2
    }

    private async Task DeleteSelectedAccounts()
    {
        var targets = selectedAccounts.ToList();
        if (targets.Count == 0)
        {
            Snackbar.Add("未选择任何账号", Severity.Info);
            return;
        }

        bool? result = await DialogService.ShowMessageBox(
            "确认删除",
            $"确定要删除已选账号（{targets.Count} 个）吗？将同时清理 sessions 文件，且不可恢复。若部分账号删除失败，将继续删除剩余账号并汇总失败原因。",
            yesText: "删除", cancelText: "取消");

        if (result != true)
            return;

        loading = true;
        try
        {
            var success = 0;
            var failures = new List<string>();
            foreach (var a in targets)
            {
                try
                {
                    await AccountManagement.DeleteAccountAsync(a.Id);
                    success++;
                }
                catch (Exception ex)
                {
                    failures.Add($"{a.Phone}：{ex.Message}");
                }
            }

            selectedAccounts.Clear();
            await LoadAccounts();

            if (failures.Count == 0)
            {
                Snackbar.Add($"删除完成：成功 {success}/{targets.Count}", Severity.Success);
                return;
            }

            Snackbar.Add($"删除完成：成功 {success}/{targets.Count}，失败 {failures.Count}", Severity.Warning);

            // 避免 Snackbar 过长，失败原因集中弹窗展示
            var details = string.Join(Environment.NewLine, failures.Take(50));
            if (failures.Count > 50)
                details += Environment.NewLine + $"... 仅展示前 50 条（共 {failures.Count} 条）";

            await DialogService.ShowMessageBox(
                "删除失败明细",
                details,
                yesText: "知道了");
        }
        catch (Exception ex)
        {
            Snackbar.Add($"删除失败：{ex.Message}", Severity.Error);
        }
        finally
        {
            loading = false;
        }
    }

    private void ExportSelectedAccounts()
    {
        var ids = selectedAccounts.Select(a => a.Id).Distinct().ToList();
        if (ids.Count == 0)
        {
            Snackbar.Add("请先勾选要导出的账号", Severity.Info);
            return;
        }

        var qs = string.Join(",", ids);
        Navigation.NavigateTo($"/downloads/accounts.zip?ids={qs}", forceLoad: true);
    }

    private void ExportCurrentAccounts()
    {
        var ids = filteredAccounts.Select(a => a.Id).Distinct().ToList();
        if (ids.Count == 0)
        {
            Snackbar.Add("当前列表没有账号可导出", Severity.Info);
            return;
        }

        var qs = string.Join(",", ids);
        Navigation.NavigateTo($"/downloads/accounts.zip?ids={qs}", forceLoad: true);
    }

    private async Task OpenSystemInbox(Account account)
    {
        var parameters = new DialogParameters
        {
            ["AccountId"] = account.Id,
            ["Phone"] = account.Phone
        };

        var options = new DialogOptions { CloseOnEscapeKey = true, MaxWidth = MaxWidth.Medium, FullWidth = true };
        DialogService.Show<TelegramPanel.Web.Components.Dialogs.SystemInboxDialog>("系统通知（验证码）", parameters, options);
        await Task.CompletedTask;
    }

    private async Task OpenDevices(Account account)
    {
        var parameters = new DialogParameters
        {
            ["AccountId"] = account.Id,
            ["Phone"] = account.Phone
        };

        var options = new DialogOptions { CloseOnEscapeKey = true, MaxWidth = MaxWidth.Large, FullWidth = true };
        DialogService.Show<TelegramPanel.Web.Components.Dialogs.OnlineDevicesDialog>("在线设备", parameters, options);
        await Task.CompletedTask;
    }

    private async Task ToggleActive(Account account)
    {
        try
        {
            var newIsActive = !account.IsActive;
            await AccountManagement.SetAccountActiveStatusAsync(account.Id, newIsActive);

            // 注意：Account 实体可能被同一个 DbContext 跟踪，SetAccountActiveStatusAsync 内部已更新该实例。
            // 这里用 newIsActive 赋值/提示，避免出现“又反转一次”的提示错误。
            account.IsActive = newIsActive;
            Snackbar.Add($"账号已{(newIsActive ? "启用" : "停用")}", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"操作失败：{ex.Message}", Severity.Error);
        }
    }

    private async Task DeleteAccount(Account account)
    {
        bool? result = await DialogService.ShowMessageBox(
            "确认删除",
            $"确定要删除账号 {account.Phone} 吗？此操作不可撤销！",
            yesText: "删除", cancelText: "取消");

        if (result == true)
        {
            try
            {
                await AccountManagement.DeleteAccountAsync(account.Id);
                accounts.Remove(account);
                Snackbar.Add("账号已删除", Severity.Success);
            }
            catch (Exception ex)
            {
                Snackbar.Add($"删除失败：{ex.Message}", Severity.Error);
            }
        }
    }
}
