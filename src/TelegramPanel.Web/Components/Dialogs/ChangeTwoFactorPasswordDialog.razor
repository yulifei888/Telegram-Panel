@namespace TelegramPanel.Web.Components.Dialogs
@inject AccountManagementService AccountManagement
@inject TelegramPanel.Core.Services.Telegram.AccountTelegramToolsService AccountTelegramTools
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@using TelegramPanel.Data.Entities

<MudDialog>
    <DialogContent>
        <MudStack Spacing="2">
            <MudAlert Severity="Severity.Warning" Variant="Variant.Outlined" Dense="true">
                将对选中的账号批量修改 Telegram 两步验证（二级密码）。请确认你输入的“原二级密码”在这些账号上是一致的，否则对应账号会失败。
            </MudAlert>

            <MudText Typo="Typo.subtitle2">账号数量：@accounts.Count</MudText>

            <MudTextField @bind-Value="currentPassword" Label="原二级密码" Variant="Variant.Outlined" InputType="InputType.Password"
                          HelperText="如果账号未开启两步验证，可留空" />

            <MudTextField @bind-Value="newPassword" Label="新二级密码" Variant="Variant.Outlined" InputType="InputType.Password"
                          Required="true" />

            <MudTextField @bind-Value="confirmPassword" Label="确认新二级密码" Variant="Variant.Outlined" InputType="InputType.Password"
                          Required="true" />

            <MudTextField @bind-Value="hint" Label="密码提示（可选）" Variant="Variant.Outlined"
                          HelperText="Telegram 会展示给你作为提示，建议不要写明文密码" />

            @if (running || results.Count > 0)
            {
                <MudDivider Class="my-2" />

                <MudStack direction="Row" AlignItems="AlignItems.Center" Spacing="2">
                    <MudText Typo="Typo.body2">进度：@processed / @accounts.Count</MudText>
                    <MudText Typo="Typo.body2" Color="Color.Success">成功：@success</MudText>
                    <MudText Typo="Typo.body2" Color="Color.Error">失败：@failed</MudText>
                    @if (running)
                    {
                        <MudProgressCircular Indeterminate="true" Size="Size.Small" />
                    }
                </MudStack>

                <MudTable Items="@results" Dense="true" Hover="true" Breakpoint="Breakpoint.Sm">
                    <HeaderContent>
                        <MudTh>账号</MudTh>
                        <MudTh>结果</MudTh>
                        <MudTh>原因</MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd DataLabel="账号">@context.Phone</MudTd>
                        <MudTd DataLabel="结果">
                            <MudChip T="string" Size="Size.Small" Color="@(context.Success ? Color.Success : Color.Error)">
                                @(context.Success ? "成功" : "失败")
                            </MudChip>
                        </MudTd>
                        <MudTd DataLabel="原因">@((context.Error ?? "").Trim())</MudTd>
                    </RowTemplate>
                </MudTable>
            }
        </MudStack>
    </DialogContent>
    <DialogActions>
        <MudButton Variant="Variant.Text" Color="Color.Default" OnClick="Cancel" Disabled="@running">关闭</MudButton>
        <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="Start" Disabled="@running">
            @if (running)
            {
                <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                <span>执行中...</span>
            }
            else
            {
                <span>开始修改</span>
            }
        </MudButton>
    </DialogActions>
</MudDialog>

@code
{
    [CascadingParameter] private MudDialogInstance MudDialog { get; set; } = default!;
    [Parameter] public IReadOnlyList<int> AccountIds { get; set; } = Array.Empty<int>();

    private List<Account> accounts = new();

    private string currentPassword = "";
    private string newPassword = "";
    private string confirmPassword = "";
    private string hint = "";

    private bool running;
    private int processed;
    private int success;
    private int failed;

    private readonly List<ResultRow> results = new();

    protected override async Task OnInitializedAsync()
    {
        var ids = AccountIds?.Distinct().Where(x => x > 0).ToList() ?? new List<int>();
        if (ids.Count == 0)
            return;

        var all = await AccountManagement.GetAllAccountsAsync();
        accounts = all.Where(a => ids.Contains(a.Id)).OrderBy(a => a.Id).ToList();
    }

    private async Task Start()
    {
        if (running)
            return;

        if (accounts.Count == 0)
        {
            Snackbar.Add("未选择账号", Severity.Warning);
            return;
        }

        if (string.IsNullOrWhiteSpace(newPassword))
        {
            Snackbar.Add("新二级密码不能为空", Severity.Warning);
            return;
        }

        if (!string.Equals(newPassword, confirmPassword, StringComparison.Ordinal))
        {
            Snackbar.Add("两次输入的新二级密码不一致", Severity.Warning);
            return;
        }

        bool? confirm = await DialogService.ShowMessageBox(
            "确认修改",
            $"将对 {accounts.Count} 个账号修改二级密码。是否继续？",
            yesText: "继续", cancelText: "取消");

        if (confirm != true)
            return;

        running = true;
        processed = 0;
        success = 0;
        failed = 0;
        results.Clear();

        try
        {
            foreach (var a in accounts)
            {
                var (ok, err) = await AccountTelegramTools.ChangeTwoFactorPasswordAsync(
                    accountId: a.Id,
                    currentPassword: currentPassword,
                    newPassword: newPassword,
                    hint: hint,
                    cancellationToken: CancellationToken.None);

                processed++;
                if (ok) success++; else failed++;
                results.Add(new ResultRow(a.Phone, ok, err));
                StateHasChanged();
            }

            Snackbar.Add($"二级密码修改完成：成功 {success}/{accounts.Count}，失败 {failed}/{accounts.Count}", failed == 0 ? Severity.Success : Severity.Warning);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"执行失败：{ex.Message}", Severity.Error);
        }
        finally
        {
            running = false;
        }
    }

    private void Cancel() => MudDialog.Close();

    private sealed record ResultRow(string Phone, bool Success, string? Error);
}
